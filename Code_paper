---
title: "Better two than one: considering female´s morphology increases the understanding of Anolis diversification"
authors: Rodríguez-Rodriguez J.D. & Calderón-Espinosa M.L
---
```{r}
#Preparing work environment
#setwd(C:/Users/juadr/OneDrive/Escritorio/Documentos trabajo de grado/Anolis_R)
#Clean workspace
rm(list=ls())
#Call packages
library(ape)
library(factoextra)
library(devtools)
library(MVN)
library(mvnormtest)
library(bestNormalize)
library(mnormt)
library(nortest)
library(permute)
library(MASS)
library(tidyverse)
library(klaR)
library(pander)
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(vegan)
library(car)
library(geiger)
library(nlme)
library(phytools)
library(maps)
library(phangorn)
library(dplyr)
library(stats)
library(cluster)
library(surface)
```
```{r}
#species analysis
#data
data<-read.csv("species.csv",header = TRUE,sep=";")
#Create separate objects
data<-textshape::column_to_rownames(data, loc = 1)
CLADE = as.factor((data)[,1])
MT = as.factor((data)[,2])
f_SVL = as.numeric((data)[,3])
f_TL = as.numeric((data)[,4])
f_FlL = as.numeric((data)[,5])
f_HlL = as.numeric((data)[,6])
f_TrL = as.numeric((data)[,7])
f_HW = as.numeric((data)[,8])
f_HH = as.numeric((data)[,9])
f_HL = as.numeric((data)[,10])
f_LN = as.numeric((data)[,11])
m_SVL = as.numeric((data)[,12])
m_TL = as.numeric((data)[,13])
m_FlL = as.numeric((data)[,14])
m_HlL = as.numeric((data)[,15])
m_TrL = as.numeric((data)[,16])
m_HW = as.numeric((data)[,17])
m_HH = as.numeric((data)[,18])
m_HL = as.numeric((data)[,19])
m_LN = as.numeric((data)[,20])
#Logarithm transformation 
log_f_SVL<-log10(f_SVL)
log_f_FlL<-log10(f_FlL)
log_f_HlL<-log(f_HlL)
log_f_TrL<-log(f_TrL)
log_f_HW<-log(f_HW)
log_f_HH<-log(f_HH)
log_f_HL<-log(f_HL)
log_f_LN<-log(f_LN)
log_m_SVL<-log(m_SVL)
log_m_FlL<-log(m_FlL)
log_m_HlL<-log(m_HlL)
log_m_TrL<-log(m_TrL)
log_m_HW<-log(m_HW)
log_m_HH<-log(m_HH)
log_m_HL<-log(m_HL)
log_m_LN<-log(m_LN)
```
```{r}
#size correction without phylogeny
f_regFlL = lm(f_SVL ~ log_f_FlL) 
f_regHlL = lm(f_SVL ~ log_f_HlL) 
f_regTrL = lm(f_SVL ~ log_f_TrL)
f_regHW = lm(f_SVL ~ log_f_HW)
f_regHH = lm(f_SVL ~ log_f_HH) 
f_regHL = lm(f_SVL ~ log_f_HL) 
f_regLN = lm(f_SVL ~ log_f_LN) 
f_FlL.res = f_regFlL$resid
f_HlL.res = f_regHlL$resid
f_TrL.res = f_regTrL$resid
f_HW.res = f_regHW$resid
f_HH.res = f_regHH$resid
f_HL.res = f_regHL$resid
f_LN.res = f_regLN$resid
f_names = row.names(data)
f_log.data.res = data.frame(cbind(log_f_SVL, f_FlL.res, f_HL.res, f_TrL.res, f_HW.res, f_HH.res, f_HL.res, f_LN.res))
write.csv(f_log.data.res,file = "f_log_data.csv")
m_regFlL = lm(m_SVL ~ log_m_FlL) 
m_regHlL = lm(m_SVL ~ log_m_HlL) 
m_regTrL = lm(m_SVL ~ log_m_TrL)
m_regHW = lm(m_SVL ~ log_m_HW)
m_regHH = lm(m_SVL ~ log_m_HH) 
m_regHL = lm(m_SVL ~ log_m_HL) 
m_regLN = lm(m_SVL ~ log_m_LN) 
m_FlL.res = m_regFlL$resid
m_HlL.res = m_regHlL$resid
m_TrL.res = m_regTrL$resid
m_HW.res = m_regHW$resid
m_HH.res = m_regHH$resid
m_HL.res = m_regHL$resid
m_LN.res = m_regLN$resid
m_names = row.names(data)
m_log.data.res = data.frame(cbind(log_m_SVL, m_FlL.res, m_HL.res, m_TrL.res, m_HW.res, m_HH.res, m_HL.res, m_LN.res))
write.csv(m_log.data.res,file = "m_log_data.csv")
```
```{r}
#Sexual Dimorphism indexes
SEDi<-sqrt((((log_m_FlL-m_SVL)-(log_f_FlL-f_SVL))^2)+(((log_m_HlL-m_SVL)-(log_f_HlL-f_SVL))^2)+(((log_m_TrL-m_SVL)-(log_f_TrL-f_SVL))^2)+(((log_m_HH-m_SVL)-(log_f_HH-f_SVL))^2)+(((log_m_HW-m_SVL)-(log_f_HW-f_SVL))^2)+(((log_m_HL-m_SVL)-(log_f_HL-f_SVL))^2)+(((log_m_LN-m_SVL)-(log_f_LN-f_SVL))^2))
SEDi_body<-sqrt((((log_m_FlL-m_SVL)-(log_f_FlL-f_SVL))^2)+(((log_m_HlL-m_SVL)-(log_f_HlL-f_SVL))^2)+(((log_m_TrL-m_SVL)-(log_f_TrL-f_SVL))^2))
SEDi_eco<-sqrt((((log_m_FlL-m_SVL)-(log_f_FlL-f_SVL))^2)+(((log_m_HlL-m_SVL)-(log_f_HlL-f_SVL))^2)+(((log_m_LN-m_SVL)-(log_f_LN-f_SVL))^2))
SEDi_head<-sqrt((((log_m_HH-m_SVL)-(log_f_HH-f_SVL))^2)+(((log_m_HW-m_SVL)-(log_f_HW-f_SVL))^2)+(((log_m_HL-m_SVL)-(log_f_HL-f_SVL))^2)+(((log_m_LN-m_SVL)-(log_f_LN-f_SVL))^2))
SEDi_rep<-sqrt((((log_m_TrL-m_SVL)-(log_f_TrL-f_SVL))^2))
SSDi<-(log_m_SVL/log_f_SVL)
size<-((m_SVL+f_SVL)/2)
SD<-data.frame(m_names,SEDi,SEDi_body,SEDi_head,SEDi_eco,SEDi_rep,SSDi,size,MT)
SD<-textshape::column_to_rownames(SD, loc = 1)
#PLOT
size<-SD$size
SEDi<-SD$SEDi
SSDi<-SD$SSDi
MT<-SD$MT
plot<-ggplot(SD, aes(size, SEDi_head))+  geom_point(aes(colour = MT), size = 4, alpha = 0.6) +stat_smooth(method = "lm", col = "dimgray")
plot 
plot+labs(x = "Size (mm)", y = "SEDi")
ggsave("SEDi_plot_head.pdf", 
       dpi = 600, 
       width = 200, height = 150, unit = "mm")
plot<-ggplot(SD, aes(size, SSDi))+  geom_point(aes(colour = MT), size = 4, alpha = 0.6) +stat_smooth(method = "lm", col = "dimgray")+geom_hline(yintercept = 1, linetype = "dotdash",color = "dimgray",size=0.75)
plot 
plot+labs(x = "Size (mm)", y = "SSDi")
ggsave("sSDi_plot.pdf", 
       dpi = 600, 
  
            width = 200, height = 150, unit = "mm")
```

```{r}
###POLYTHETIC HIERARCHICAL DIVISIVE CLUSTERING METHOD IN AN ORDINATION SPACE 
#create dataframe with corrected data 
data.cor.f = data.frame(cbind(f_SVL, f_FlL.res, f_HlL.res, f_TrL.res,f_HW.res, f_LN.res))
f_names<-paste(f_names,"female",sep = "_")
cor.females<-data.frame(cbind(f_names,f_SVL, f_FlL.res, f_HlL.res, f_TrL.res,f_HW.res, f_LN.res))
#write.csv(cor.females,file ="corrected_females.csv" )
data.cor.m = data.frame(cbind(m_SVL, m_FlL.res, m_HlL.res, m_TrL.res,m_HW.res, m_LN.res))
m_names = paste(m_names, "male",sep = "_")
cor.males = data.frame(cbind(m_names,m_SVL, m_FlL.res, m_HlL.res, m_TrL.res,m_HW.res, m_LN.res))
#write.csv(cor.males,file = "corrected_males.csv")
cor.total<-read.csv("corrected_total.csv",header = TRUE,sep = ",")
#pca
res.pca.m<-prcomp(data.cor.m, scale. = TRUE)
res.pca.f <- prcomp(data.cor.f, scale. = TRUE)
scores.f<-res.pca.f$x
scores.f<-data.frame((cbind(f_names,scores.f)))
scores.f<-textshape::column_to_rownames(scores.f, loc = 1)
res.pca.m <- prcomp(data.cor.m, scale. = TRUE)
scores.m<-res.pca.m$x
scores.m<-data.frame((cbind(m_names,scores.f)))
scores.m<-textshape::column_to_rownames(scores.m, loc = 1)
pos.f<-subset.data.frame(scores.f,subset = scores.f$PC1>1)
neg.f<-subset.data.frame(scores.f,subset = scores.f$PC1<1)
pos.m<-subset.data.frame(scores.m,subset = scores.m$PC1>1)
neg.f<-subset.data.frame(scores.m,subset = scores.m$PC1<1)
write.csv(res.pca$x,file = "pca_scores.csv")
```
```{r}
#Is the patern of body size dimorphism, and sex differences in ecomorphological traits explained by averaged body size of the species? 
SSDI_COMPLETE<-read.csv("SSDI_COMPLETE.csv",header = TRUE,sep = ";")
SSDi<-na.omit(SSDI_COMPLETE)
shapiro.test(SSDi$Dim)
shapiro.test(SSDi$Manhattan_PCA)
shapiro.test(SSDi$SIZE)
cor.test(SSDi$SIZE,SSDi$Dim,method = "spearman")
bias<-as.factor(SSDi$BIAS)
mt<-as.factor(SSDi$MT)
plot<-ggplot(SSDi, aes(SIZE, Dim))+  geom_point(aes(shape = BIAS, colour = MT), size = 4, alpha = 0.6) +stat_smooth(method = "lm", col = "dimgray")
plot 
  
plot+geom_vline(xintercept = 60, linetype="dashed", color = "dimgray", size=1)+geom_vline(xintercept = 90, linetype="dashed", color = "dimgray", size=1)+labs(x = "Size (mm)", y = "Size Dimorphism (%)")+geom_hline(yintercept = 5, linetype = "dashed",color = "red",size=1)
ggsave("SizeDimorphism_plot.pdf", 
       dpi = 600, 
       width = 200, height = 150, unit = "mm")
##Shape dimorphism 
shapiro.test(SSDi$Manhattan_PCA)
shapiro.test(SSDi$SIZE)
cor.test(SSDi$SIZE,SSDi$Manhattan_PCA,method = "spearman")
lm<-lm(formula = SIZE ~ Dim, data = SSDi)
summary.lm(lm)
bias<-as.factor(SSDi$BIAS)
mt<-as.factor(SSDi$MT)
plot<-ggplot(SSDi, aes(SIZE, Manhattan_PCA))+  geom_point(aes(colour = MT), size = 4, alpha = 0.6) +stat_smooth(method = "lm", col = "dimgray")
plot 
  
plot+geom_vline(xintercept = 60, linetype="dashed", color = "dimgray", size=1)+geom_vline(xintercept = 90, linetype="dashed", color = "dimgray", size=1)+labs(x = "Size (mm)", y = "Ecomorphological Dimorphism (Manhattan Distance)")+geom_hline(yintercept = 3.6, linetype = "dashed",color = "red",size=1)
ggsave("SHapeDimorphism_plot.pdf", 
       dpi = 600, 
       width = 200, height = 150, unit = "mm")
```
```{r}
##Cluster-versión ChatGPT 
# load your data into R
data.cor.t <- read.csv("corrected_total.csv",sep = ";")
data.cor.t<-textshape::column_to_rownames(data.cor.t, loc = 1)

# perform ordination analysis on your data
dist.t<-dist(data.cor.t,method = "euclidean")
ordination <- cmdscale(dist.t)

# perform polythetic hierarchical divisive clustering
cluster <- hclust(dist(ordination), method = "average")

# plot the dendrogram
plot(cluster)
#males
data.cor.m = data.frame(cbind(m_names,m_SVL, m_FlL.res, m_HlL.res, m_TrL.res,m_HW.res, m_LN.res))
data.cor.m<-textshape::column_to_rownames(data.cor.m, loc = 1)
dist.m<-dist(data.cor.m,method = "euclidean")
ordination <- cmdscale(dist.m)

# perform polythetic hierarchical divisive clustering
cluster.m <- hclust(dist(ordination), method = "average")

# plot the dendrogram
plot(cluster.m)
